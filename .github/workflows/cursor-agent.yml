name: Fix CI Failures

on:
    workflow_run:
        # These names must match the `name:` field in the workflows you want to
        # react to (not the filename).
        workflows: [Run All Tests]
        types: [completed]
    # Allows manually re-running the agent against an *existing* workflow run,
    # but using the *current* workflow definition (useful when you updated the
    # agent workflow/scripts and want to re-try a past failure).
    workflow_dispatch:
        inputs:
            run_repository:
                description: "Repo that contains the workflow run to analyze (owner/repo). Defaults to this repo."
                required: false
                default: ""
            run_id:
                description: "The workflow run id to analyze (e.g. 1234567890)."
                required: true
            run_url:
                description: "Optional: workflow run URL (if omitted, the script will try to resolve it via the API)."
                required: false
                default: ""

permissions:
    contents: write
    pull-requests: write
    actions: read

jobs:
    attempt-fix:
        if: >-
            ${{
              (github.event_name == 'workflow_run' &&
                github.event.workflow_run.conclusion == 'failure' &&
                github.event.workflow_run.name != 'Fix CI Failures') ||
              (github.event_name == 'workflow_dispatch')
            }}
        runs-on: ubuntu-latest
        timeout-minutes: 120
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Debug context (what cursor-agent receives)
              if: ${{ always() }}
              run: |
                  set -euo pipefail
                  echo "=== cursor-agent context ==="
                  echo "event_name=${{ github.event_name }}"
                  echo "repository=${{ github.repository }}"
                  echo "ref=${{ github.ref }}"
                  echo "sha=${{ github.sha }}"
                  echo "--- workflow_run (when event_name=workflow_run) ---"
                  echo "workflow_run.id=${{ github.event.workflow_run.id }}"
                  echo "workflow_run.name=${{ github.event.workflow_run.name }}"
                  echo "workflow_run.event=${{ github.event.workflow_run.event }}"
                  echo "workflow_run.status=${{ github.event.workflow_run.status }}"
                  echo "workflow_run.conclusion=${{ github.event.workflow_run.conclusion }}"
                  echo "workflow_run.head_branch=${{ github.event.workflow_run.head_branch }}"
                  echo "workflow_run.head_sha=${{ github.event.workflow_run.head_sha }}"
                  echo "workflow_run.html_url=${{ github.event.workflow_run.html_url }}"
                  echo "workflow_run.pull_requests=${{ toJson(github.event.workflow_run.pull_requests) }}"
                  echo "workflow_run.actor=${{ github.event.workflow_run.actor && github.event.workflow_run.actor.login || '' }}"
                  echo "workflow_run.triggering_actor=${{ github.event.workflow_run.triggering_actor && github.event.workflow_run.triggering_actor.login || '' }}"
                  echo "--- workflow_dispatch inputs (when event_name=workflow_dispatch) ---"
                  echo "inputs.run_repository=${{ inputs.run_repository }}"
                  echo "inputs.run_id=${{ inputs.run_id }}"
                  echo "inputs.run_url=${{ inputs.run_url }}"
                  echo "========================================"

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.38.1"
                  channel: "stable"
                  cache: true

            - name: Install Cursor CLI
              run: |
                  curl https://cursor.com/install -fsS | bash
                  echo "$HOME/.cursor/bin" >> $GITHUB_PATH

            # IMPORTANT: The workflows in this repo run tests against a *cloned*
            # target repo. The agent should propose/fix changes in that target
            # repo, not in this orchestrator repo.
            - name: Setup SSH (deploy key) for target repo
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.REPO_SSH_KEY }}

            - name: Trust github.com host key
              run: |
                  set -euo pipefail
                  mkdir -p ~/.ssh
                  ssh-keyscan github.com >> ~/.ssh/known_hosts

            - name: Clone target repository
              env:
                  REPO_PATH: ${{ secrets.REPO_PATH }}
              run: |
                  set -euo pipefail
                  git clone "${REPO_PATH}" repo

            - name: Create .env
              run: |
                  set -euo pipefail
                  cd repo
                  bash ../.github/scripts/create-env.sh "${{ secrets.ENV_FILE_B64 }}"
                  bash ../.github/scripts/generate-envied-sources.sh

            - name: Fix CI failure
              env:
                  CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
                  MODEL: gpt-5.2
                  # IMPORTANT:
                  # - `github.token` / `secrets.GITHUB_TOKEN` often cannot access a *different* private target repo (it will 404).
                  # - Provide a fine-grained PAT (or GitHub App token) with access to BOTH:
                  #   - this orchestrator repo (to read the workflow run / comment on PRs)
                  #   - the target repo (to push branches / open PRs)
                  GH_TOKEN: ${{ secrets.CURSOR_AGENT_GH_TOKEN || github.token }}
                  TARGET_GH_TOKEN: ${{ secrets.CURSOR_AGENT_GH_TOKEN || '' }}
                  # Force HTTPS origin for pushes so we use the PAT (not the SSH deploy key).
                  # This is required when the deploy key is read-only.
                  CURSOR_AGENT_FORCE_HTTPS_ORIGIN: "true"
                  BRANCH_PREFIX: ci-fix
                  # Repo where the run to analyze happened.
                  # - workflow_run: this repo
                  # - workflow_dispatch: optional override (owner/repo)
                  RUN_REPOSITORY: >-
                      ${{
                        (github.event_name == 'workflow_dispatch' && inputs.run_repository != '' && inputs.run_repository) ||
                        github.repository
                      }}
                  GH_REPOSITORY: ${{ secrets.GH_REPOSITORY }}
                  GH_REPOSITORY_OWNER: ${{ secrets.GH_REPOSITORY_OWNER }}
                  GH_REPOSITORY_NAME: ${{ secrets.GH_REPOSITORY_NAME }}
                  # Run id/url for the run to analyze.
                  GH_RUN_ID: >-
                      ${{
                        (github.event_name == 'workflow_dispatch' && inputs.run_id) ||
                        github.event.workflow_run.id
                      }}
                  GH_RUN_URL: >-
                      ${{
                        (github.event_name == 'workflow_dispatch' && inputs.run_url) ||
                        github.event.workflow_run.html_url
                      }}
                  # Where the target repo was cloned to.
                  TARGET_WORKDIR: repo
              run: |
                  .github/scripts/run-cursor.sh

