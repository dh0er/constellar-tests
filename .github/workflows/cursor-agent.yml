name: Fix CI Failures

on:
    workflow_run:
        # These names must match the `name:` field in the workflows you want to
        # react to (not the filename).
        workflows: [Run All Tests]
        types: [completed]

permissions:
    contents: write
    pull-requests: write
    actions: read

jobs:
    attempt-fix:
        if: >-
            ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.name != 'Fix CI Failures' }}
        runs-on: ubuntu-latest
        timeout-minutes: 60
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Debug workflow_run context (what cursor-agent receives)
              if: ${{ always() }}
              run: |
                  set -euo pipefail
                  echo "=== workflow_run (tests repo) context ==="
                  echo "repository=${{ github.repository }}"
                  echo "workflow_run.id=${{ github.event.workflow_run.id }}"
                  echo "workflow_run.name=${{ github.event.workflow_run.name }}"
                  echo "workflow_run.event=${{ github.event.workflow_run.event }}"
                  echo "workflow_run.status=${{ github.event.workflow_run.status }}"
                  echo "workflow_run.conclusion=${{ github.event.workflow_run.conclusion }}"
                  echo "workflow_run.head_branch=${{ github.event.workflow_run.head_branch }}"
                  echo "workflow_run.head_sha=${{ github.event.workflow_run.head_sha }}"
                  echo "workflow_run.html_url=${{ github.event.workflow_run.html_url }}"
                  echo "workflow_run.pull_requests=${{ toJson(github.event.workflow_run.pull_requests) }}"
                  echo "workflow_run.actor=${{ github.event.workflow_run.actor && github.event.workflow_run.actor.login || '' }}"
                  echo "workflow_run.triggering_actor=${{ github.event.workflow_run.triggering_actor && github.event.workflow_run.triggering_actor.login || '' }}"
                  echo "========================================"

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.38.1"
                  channel: "stable"
                  cache: true

            - name: Install Cursor CLI
              run: |
                  curl https://cursor.com/install -fsS | bash
                  echo "$HOME/.cursor/bin" >> $GITHUB_PATH

            # IMPORTANT: The workflows in this repo run tests against a *cloned*
            # target repo. The agent should propose/fix changes in that target
            # repo, not in this orchestrator repo.
            - name: Setup SSH (deploy key) for target repo
              uses: webfactory/ssh-agent@v0.9.0
              with:
                  ssh-private-key: ${{ secrets.REPO_SSH_KEY }}

            - name: Trust github.com host key
              run: |
                  set -euo pipefail
                  mkdir -p ~/.ssh
                  ssh-keyscan github.com >> ~/.ssh/known_hosts

            - name: Clone target repository
              env:
                  REPO_PATH: ${{ secrets.REPO_PATH }}
              run: |
                  set -euo pipefail
                  git clone "${REPO_PATH}" repo

            - name: Fix CI failure
              env:
                  CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
                  MODEL: gpt-5.2
                  # IMPORTANT:
                  # - `github.token` / `secrets.GITHUB_TOKEN` often cannot access a *different* private target repo (it will 404).
                  # - Provide a fine-grained PAT (or GitHub App token) with access to BOTH:
                  #   - this orchestrator repo (to read the workflow run / comment on PRs)
                  #   - the target repo (to push branches / open PRs)
                  GH_TOKEN: ${{ secrets.CURSOR_AGENT_GH_TOKEN || github.token }}
                  TARGET_GH_TOKEN: ${{ secrets.CURSOR_AGENT_GH_TOKEN || '' }}
                  BRANCH_PREFIX: ci-fix
                  # Repo where this workflow_run event happened (this repo).
                  RUN_REPOSITORY: ${{ github.repository }}
                  GH_REPOSITORY: ${{ secrets.GH_REPOSITORY }}
                  GH_REPOSITORY_OWNER: ${{ secrets.GH_REPOSITORY_OWNER }}
                  GH_REPOSITORY_NAME: ${{ secrets.GH_REPOSITORY_NAME }}
                  GH_RUN_ID: ${{ github.event.workflow_run.id }}
                  GH_RUN_URL: ${{ github.event.workflow_run.html_url }}
                  # Where the target repo was cloned to.
                  TARGET_WORKDIR: repo
              run: |
                  .github/scripts/run-cursor.sh

