name: Windows

on:
  workflow_dispatch:

jobs:
  test:
    name: Run tests on Windows
    runs-on: windows-latest
    env:
      REPO_PATH: ${{ secrets.REPO_PATH }}
      ENV_FILE_B64: ${{ secrets.ENV_FILE_B64 }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup SSH (deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.REPO_SSH_KEY }}
      - name: Trust github.com host key
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.ssh" | Out-Null
          ssh-keyscan github.com | Out-File -FilePath "$env:USERPROFILE\.ssh\known_hosts" -Append -Encoding ascii
      - name: Clone repository
        shell: pwsh
        run: git clone "${{ secrets.REPO_PATH }}" repo
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.1"
          channel: "stable"
          cache: true
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
      - name: Run interpreter (execute 'run' steps from cloned workflow)
        shell: pwsh
        run: ruby .github/scripts/run_workflow_run_steps.rb --workflow repo/.github/workflows/tests-windows.yml --job layer1-tests --default-working-directory repo
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: layer1-screenshots-windows
          path: repo/integration_test/screenshots/
          if-no-files-found: ignore