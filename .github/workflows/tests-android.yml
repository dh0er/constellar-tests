name: Android

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "Source repo that triggered this workflow"
        required: false
        default: ""
      source_ref:
        description: "Git ref in the source repo to test (e.g. refs/pull/123/merge or refs/heads/main)"
        required: false
        default: ""
      source_sha:
        description: "Commit SHA in the source repo to test (optional)"
        required: false
        default: ""
      source_pr:
        description: "PR number in the source repo (optional)"
        required: false
        default: ""

concurrency:
  group: >-
    tests-android-${{ inputs.source_repo || github.repository }}-${{ inputs.source_pr || inputs.source_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  test:
    name: Run tests on Android emulator
    runs-on: ubuntu-latest
    timeout-minutes: 360
    env:
      REPO_PATH: ${{ secrets.REPO_PATH }}
      ENV_FILE_B64: ${{ secrets.ENV_FILE_B64 }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup SSH (deploy key)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.REPO_SSH_KEY }}
      - name: Trust github.com host key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts
      - name: Clone repository
        run: git clone "${{ secrets.REPO_PATH }}" repo
      - name: Checkout requested source ref/SHA (optional)
        if: ${{ inputs.source_ref != '' || inputs.source_sha != '' }}
        working-directory: repo
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.source_ref }}" ]; then
            echo "Fetching source ref: ${{ inputs.source_ref }}"
            git fetch --no-tags --prune origin "${{ inputs.source_ref }}"
            git checkout --detach FETCH_HEAD
          elif [ -n "${{ inputs.source_sha }}" ]; then
            echo "Checking out source sha: ${{ inputs.source_sha }}"
            # Try to fetch the object in case it's not present in the clone.
            git fetch --no-tags --prune origin "${{ inputs.source_sha }}" || true
            git checkout --detach "${{ inputs.source_sha }}"
          fi
          echo "Checked out commit:"
          git rev-parse HEAD
      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.1"
          channel: "stable"
          cache: true
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
      - name: Run interpreter (execute 'run' steps from cloned workflow)
        run: ruby .github/scripts/run_workflow_run_steps.rb --workflow repo/.github/workflows/tests-android.yml --job layer1-tests --default-working-directory repo
      - name: Run tests on Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
          ANDROID_HOME: /usr/local/lib/android/sdk
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel_6
          # CI stability notes:
          # - The emulator repeatedly warns that 2 cores is suboptimal; bump to 4 to reduce freezes.
          # - Prefer software SwiftShader; `swiftshader_indirect` has shown intermittent gfxstream hangs.
          # - Disable boot animation to reduce startup time/variance.
          emulator-options: -no-window -no-audio -no-snapshot -no-boot-anim -gpu swiftshader -no-metrics
          cores: 4
          # With KVM enabled above, let the action use hardware acceleration.
          disable-linux-hw-accel: false
          emulator-boot-timeout: 900
          disable-animations: true
          script: cd repo && ./.github/scripts/tests-android/layer1-tests/run-tests.sh
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: layer1-screenshots-android
          path: repo/integration_test/screenshots/
          if-no-files-found: ignore
